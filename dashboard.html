<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - PetMat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .navbar {
      max-width: 1200px;
      margin: 0 auto 20px;
      background: #fff;
      border-radius: 10px;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    .navbar h3 {
      color: #667eea;
      font-size: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    .section h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 20px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-weight: 600;
      color: #333;
    }
    .info-value {
      color: #666;
      font-family: monospace;
      font-size: 13px;
      max-width: 60%;
      word-break: break-all;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: .3s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .btn-primary {
      background: #667eea;
      color: #fff;
    }
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: #764ba2;
      color: #fff;
    }
    .btn-secondary:hover {
      background: #653d8f;
      transform: translateY(-2px);
    }
    .btn-danger {
      background: #dc3545;
      color: #fff;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .alert {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .hidden {
      display: none;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    .token-display {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      border: 1px solid #e0e0e0;
    }
    .token-label {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 5px;
    }
    .token-value {
      font-family: monospace;
      font-size: 12px;
      color: #333;
      word-break: break-all;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      max-height: 100px;
      overflow-y: auto;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }
    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      color: #666;
      transition: .3s;
    }
    .tab:hover {
      color: #667eea;
    }
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 25px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .profile-pic {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #667eea;
    }
    .profile-pic-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 40px;
      font-weight: bold;
    }
    .profile-info h3 {
      color: #333;
      margin-bottom: 5px;
    }
    .profile-info p {
      color: #666;
      font-size: 14px;
    }
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
      margin-right: 5px;
    }
    .badge-success {
      background: #efe;
      color: #3c3;
    }
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      color: #333;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }
    input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color .3s;
    }
    input:focus {
      border-color: #667eea;
      outline: none;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .loading-screen {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    .file-input-label {
      display: inline-block;
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .file-input-label:hover {
      background: #5568d3;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <div class="navbar">
    <h3>üêæ PetMat Dashboard</h3>
    <button id="navLogoutBtn" class="btn btn-danger" style="padding: 8px 16px;">Logout</button>
  </div>

  <div class="container">
    <h1>Dashboard</h1>
    <p class="subtitle">Welcome back! Manage your account and tokens</p>

    <div id="alertBox" class="hidden"></div>

    <div id="loadingScreen" class="loading-screen">
      <div class="spinner"></div>
      <p>Loading your profile...</p>
    </div>

    <div id="mainContent" class="hidden">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="profile">üë§ Profile</button>
        <button class="tab" data-tab="security">üîê Security & Password</button>
        <button class="tab" data-tab="tokens">üîë Token Management</button>
      </div>

      <!-- Profile Tab -->
      <div id="profile" class="tab-content active">
        <!-- Profile Overview -->
        <div class="section">
          <div class="profile-header">
            <div id="profilePicContainer"></div>
            <div class="profile-info">
              <h3 id="userNameDisplay">Loading...</h3>
              <p id="userEmailDisplay">Loading...</p>
              <div id="userBadges"></div>
            </div>
          </div>

          <div class="file-input-wrapper">
            <input type="file" id="profilePicInput" accept="image/*" onchange="uploadProfilePicture()">
            <label for="profilePicInput" class="file-input-label">üì∑ Change Profile Picture</label>
          </div>
        </div>

        <!-- Update Name -->
        <div class="section">
          <h2>Update Name</h2>
          <form id="nameForm">
            <div class="grid">
              <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" placeholder="Enter first name">
              </div>
              <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" placeholder="Enter last name">
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Update Name</button>
          </form>
        </div>

        <!-- Update Phone -->
        <div class="section">
          <h2>Update Phone Number</h2>
          <form id="phoneForm">
            <div class="form-group">
              <label for="phoneNumber">Phone Number</label>
              <input type="tel" id="phoneNumber" placeholder="Enter phone number">
            </div>
            <button type="submit" class="btn btn-primary">Update Phone</button>
          </form>
        </div>

        <!-- Update Address -->
        <div class="section">
          <h2>Update Address</h2>
          <form id="addressForm">
            <div class="form-group">
              <label for="city">City</label>
              <input type="text" id="city" placeholder="Enter city" required>
            </div>
            <div class="form-group">
              <label for="government">Government/State</label>
              <input type="text" id="government" placeholder="Enter government" required>
            </div>
            <div class="form-group">
              <label for="country">Country</label>
              <input type="text" id="country" placeholder="Enter country" required>
            </div>
            <button type="submit" class="btn btn-primary">Update Address</button>
          </form>
        </div>
      </div>

      <!-- Security & Password Tab -->
      <div id="security" class="tab-content">
        <!-- User Info Section -->
        <div class="section">
          <h2>User Information</h2>
          <div class="info-row">
            <span class="info-label">Email:</span>
            <span class="info-value" id="userEmail">Loading...</span>
          </div>
          <div class="info-row">
            <span class="info-label">Name:</span>
            <span class="info-value" id="userName">Loading...</span>
          </div>
          <div class="info-row">
            <span class="info-label">Email Confirmed:</span>
            <span class="info-value" id="emailConfirmed">Loading...</span>
          </div>
        </div>

        <!-- Password Management -->
        <div class="section">
          <h2>Password Management</h2>
          <div id="passwordSection"></div>
        </div>
      </div>

      <!-- Token Management Tab -->
      <div id="tokens" class="tab-content">
        <!-- Current Tokens Section -->
        <div class="section">
          <h2>Current Tokens</h2>
          <div class="token-display">
            <div class="token-label">Access Token:</div>
            <div class="token-value" id="currentAccessToken">Not available</div>
          </div>
          <div class="token-display">
            <div class="token-label">Refresh Token:</div>
            <div class="token-value" id="currentRefreshToken">Not available</div>
          </div>
          <div class="token-display">
            <div class="token-label">Access Token Expires At:</div>
            <div class="token-value" id="accessTokenExpiry">Not available</div>
          </div>
        </div>

        <!-- Token Management Section -->
        <div class="section">
          <h2>Token Actions</h2>
          <div class="button-group">
            <button id="refreshTokenBtn" class="btn btn-primary">
              <span id="refreshBtnText">üîÑ Refresh Tokens</span>
            </button>
            <button id="showTokensBtn" class="btn btn-secondary">
              üìã Show Current Tokens
            </button>
          </div>
        </div>

        <!-- New Tokens Display (after refresh) -->
        <div id="newTokensSection" class="section hidden">
          <h2>‚ú® New Tokens (Refreshed)</h2>
          <div class="token-display">
            <div class="token-label">New Access Token:</div>
            <div class="token-value" id="newAccessToken">-</div>
          </div>
          <div class="token-display">
            <div class="token-label">New Refresh Token:</div>
            <div class="token-value" id="newRefreshToken">-</div>
          </div>
          <div class="token-display">
            <div class="token-label">Access Token Expires At:</div>
            <div class="token-value" id="newAccessTokenExpiry">-</div>
          </div>
          <div class="token-display">
            <div class="token-label">Refresh Token Expires At:</div>
            <div class="token-value" id="newRefreshTokenExpiry">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>

    const API_BASE = "https://localhost:7289/api";
    let userData = null;

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const target = tab.dataset.tab;
        
        // Remove active class from all tabs and contents
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        document.getElementById(target).classList.add('active');
      });
    });

    function showAlert(message, type = 'error') {
      const alertBox = document.getElementById('alertBox');
      alertBox.className = type === 'success' ? 'alert alert-success' : 'alert alert-error';
      alertBox.textContent = message;
      alertBox.classList.remove('hidden');
      window.scrollTo(0, 0);
      setTimeout(() => alertBox.classList.add('hidden'), 5000);
    }

    function getAuthHeaders() {
      const token = localStorage.getItem('accessToken');
      return {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };
    }

    function checkAuth() {
      const accessToken = localStorage.getItem("accessToken");
      if (!accessToken) {
        window.location.href = "signin.html";
        return false;
      }
      return true;
    }

    // Load user profile
    async function loadUserProfile() {
      try {
        const accessToken = localStorage.getItem("accessToken");
        const res = await fetch(`${API_BASE}/Auth/me`, {
          headers: {
            "Authorization": `Bearer ${accessToken}`
          }
        });

        if (res.status === 401) {
          await refreshAccessToken();
          return loadUserProfile();
        }

        if (!res.ok) throw new Error('Failed to load profile');

        userData = await res.json();
        displayUserProfile();
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
      } catch (err) {
        showAlert("Error loading profile: " + err.message, "error");
        setTimeout(() => window.location.href = 'signin.html', 2000);
      }
    }

    function displayUserProfile() {
      const fullName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Anonymous User';
      
      // Display in profile header
      document.getElementById('userNameDisplay').textContent = fullName;
      document.getElementById('userEmailDisplay').textContent = userData.email;
      
      // Display in security tab
      document.getElementById("userEmail").textContent = userData.email || "N/A";
      document.getElementById("userName").textContent = fullName !== 'Anonymous User' ? fullName : "Not set";
      document.getElementById("emailConfirmed").textContent = userData.emailConfirmed ? "‚úÖ Yes" : "‚ùå No";

      // Profile picture
      const picContainer = document.getElementById('profilePicContainer');
      if (userData.profilePhotoUrl) {
        picContainer.innerHTML = `<img src="${userData.profilePhotoUrl}" class="profile-pic" alt="Profile">`;
      } else {
        const initial = (userData.firstName?.[0] || userData.email?.[0] || 'U').toUpperCase();
        picContainer.innerHTML = `<div class="profile-pic-placeholder">${initial}</div>`;
      }

      // Badges
      const badgesHtml = [];
      if (userData.emailConfirmed) {
        badgesHtml.push('<span class="badge badge-success">‚úÖ Email Verified</span>');
      } else {
        badgesHtml.push('<span class="badge badge-warning">‚ö†Ô∏è Email Not Verified</span>');
      }
      userData.roles.forEach(role => {
        badgesHtml.push(`<span class="badge badge-success">${role}</span>`);
      });
      document.getElementById('userBadges').innerHTML = badgesHtml.join('');

      // Fill forms
      document.getElementById('firstName').value = userData.firstName || '';
      document.getElementById('lastName').value = userData.lastName || '';
      document.getElementById('phoneNumber').value = userData.phoneNumber || '';

      // Password section
      const passwordSection = document.getElementById('passwordSection');
      if (userData.hasPassword) {
        passwordSection.innerHTML = `
          <p style="color: #666; margin-bottom: 20px;">Update your password to keep your account secure.</p>
          <form id="updatePasswordForm">
            <div class="form-group">
              <label for="oldPassword">Current Password</label>
              <input type="password" id="oldPassword" placeholder="Enter current password" required>
            </div>
            <div class="form-group">
              <label for="newPassword">New Password</label>
              <input type="password" id="newPassword" placeholder="Enter new password (min 6 chars)" required minlength="6">
            </div>
            <div class="form-group">
              <label for="confirmNewPassword">Confirm New Password</label>
              <input type="password" id="confirmNewPassword" placeholder="Confirm new password" required>
            </div>
            <button type="submit" class="btn btn-primary">Update Password</button>
          </form>
        `;
        document.getElementById('updatePasswordForm').addEventListener('submit', updatePassword);
      } else {
        passwordSection.innerHTML = `
          <p style="color: #666; margin-bottom: 20px;">‚ö†Ô∏è You don't have a password set. Create one to enable password login.</p>
          <form id="createPasswordForm">
            <div class="form-group">
              <label for="newPasswordCreate">Password</label>
              <input type="password" id="newPasswordCreate" placeholder="Enter password (min 6 chars)" required minlength="6">
            </div>
            <div class="form-group">
              <label for="confirmPasswordCreate">Confirm Password</label>
              <input type="password" id="confirmPasswordCreate" placeholder="Confirm password" required>
            </div>
            <button type="submit" class="btn btn-primary">Create Password</button>
          </form>
        `;
        document.getElementById('createPasswordForm').addEventListener('submit', createPassword);
      }
    }

    // Display current tokens
    function displayCurrentTokens() {
      const accessToken = localStorage.getItem("accessToken");
      const refreshToken = localStorage.getItem("refreshToken");
      
      document.getElementById("currentAccessToken").textContent = accessToken || "Not available";
      document.getElementById("currentRefreshToken").textContent = refreshToken || "Not available";
      
      // Try to decode and show expiry
      try {
        if (accessToken) {
          const payload = JSON.parse(atob(accessToken.split('.')[1]));
          if (payload.exp) {
            const expiry = new Date(payload.exp * 1000);
            document.getElementById("accessTokenExpiry").textContent = expiry.toLocaleString();
          }
        }
      } catch (e) {
        document.getElementById("accessTokenExpiry").textContent = "Unable to parse";
      }
    }

    // Refresh tokens
    async function refreshTokens() {
      const refreshToken = localStorage.getItem("refreshToken");
      if (!refreshToken) {
        showAlert("No refresh token available", "error");
        return;
      }

      const btn = document.getElementById("refreshTokenBtn");
      const btnText = document.getElementById("refreshBtnText");
      const originalText = btnText.textContent;
      
      btnText.innerHTML = '<span class="loading"></span>Refreshing...';
      btn.disabled = true;

      try {
        const res = await fetch(`${API_BASE}/Auth/refresh-token`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            refreshToken: refreshToken
          })
        });

        const data = await res.json();

        if (res.ok) {
          // Update tokens in storage
          localStorage.setItem("accessToken", data.accessToken);
          localStorage.setItem("refreshToken", data.refreshToken);

          // Display new tokens
          document.getElementById("newAccessToken").textContent = data.accessToken;
          document.getElementById("newRefreshToken").textContent = data.refreshToken;
          document.getElementById("newAccessTokenExpiry").textContent = 
            new Date(data.accessTokenExpiresAt).toLocaleString();
          document.getElementById("newRefreshTokenExpiry").textContent = 
            new Date(data.refreshTokenExpiresAt).toLocaleString();

          // Show new tokens section
          document.getElementById("newTokensSection").classList.remove("hidden");

          // Update current tokens display
          displayCurrentTokens();

          showAlert("‚úÖ Tokens refreshed successfully!", "success");
        } else {
          showAlert(data.message || "Failed to refresh tokens", "error");
          
          // If refresh token is invalid, redirect to login
          if (res.status === 401) {
            setTimeout(() => {
              localStorage.clear();
              window.location.href = "signin.html";
            }, 2000);
          }
        }
      } catch (err) {
        showAlert("Network error: " + err.message, "error");
      } finally {
        btnText.textContent = originalText;
        btn.disabled = false;
      }
    }

    async function refreshAccessToken() {
      try {
        const refreshToken = localStorage.getItem('refreshToken');
        const response = await fetch(`${API_BASE}/Auth/refresh-token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refreshToken })
        });

        if (response.ok) {
          const data = await response.json();
          localStorage.setItem('accessToken', data.accessToken);
          localStorage.setItem('refreshToken', data.refreshToken);
          return true;
        }
      } catch (error) {
        console.error('Token refresh failed:', error);
      }
      window.location.href = 'signin.html';
      return false;
    }

    // Update Name
    document.getElementById('nameForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'Updating...';

      try {
        const response = await fetch(`${API_BASE}/Auth/profile/name`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value
          })
        });

        const data = await response.json();
        if (response.ok) {
          showAlert('‚úÖ Name updated successfully!', 'success');
          await loadUserProfile();
        } else {
          showAlert(data.message || 'Failed to update name');
        }
      } catch (error) {
        showAlert('Network error. Please try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Update Name';
      }
    });

    // Update Phone
    document.getElementById('phoneForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'Updating...';

      try {
        const response = await fetch(`${API_BASE}/Auth/profile/phone`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({
            phoneNumber: document.getElementById('phoneNumber').value
          })
        });

        const data = await response.json();
        if (response.ok) {
          showAlert('‚úÖ Phone number updated successfully!', 'success');
          await loadUserProfile();
        } else {
          showAlert(data.message || 'Failed to update phone');
        }
      } catch (error) {
        showAlert('Network error. Please try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Update Phone';
      }
    });

    // Update Address
    document.getElementById('addressForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'Updating...';

      try {
        const response = await fetch(`${API_BASE}/Auth/profile/address`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({
            city: document.getElementById('city').value,
            government: document.getElementById('government').value,
            country: document.getElementById('country').value
          })
        });

        const data = await response.json();
        if (response.ok) {
          showAlert('‚úÖ Address updated successfully!', 'success');
          await loadUserProfile();
        } else {
          showAlert(data.message || 'Failed to update address');
        }
      } catch (error) {
        showAlert('Network error. Please try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Update Address';
      }
    });

    // Upload Profile Picture
    async function uploadProfilePicture() {
      const fileInput = document.getElementById('profilePicInput');
      const file = fileInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('picture', file);

      try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch(`${API_BASE}/Auth/profile/picture`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        const data = await response.json();
        if (response.ok) {
          showAlert('‚úÖ Profile picture updated successfully!', 'success');
          await loadUserProfile();
        } else {
          showAlert(data.message || 'Failed to upload picture');
        }
      } catch (error) {
        showAlert('Network error. Please try again.');
      }
    }

    // Create Password
    async function createPassword(e) {
      e.preventDefault();
      const password = document.getElementById('newPasswordCreate').value;
      const confirm = document.getElementById('confirmPasswordCreate').value;

      if (password !== confirm) {
        showAlert('Passwords do not match');
        return;
      }

      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'Creating...';

      try {
        const response = await fetch(`${API_BASE}/Auth/create-password`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ password })
        });

        const data = await response.json();
        if (response.ok) {
          showAlert('‚úÖ Password created successfully!', 'success');
          await loadUserProfile();
        } else {
          showAlert(data.message || 'Failed to create password');
        }
      } catch (error) {
        showAlert('Network error. Please try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create Password';
      }
    }

    // Update Password
    async function updatePassword(e) {
      e.preventDefault();
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmNewPassword').value;

      if (newPassword !== confirm) {
        showAlert('New passwords do not match');
        return;
      }

      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'Updating...';

      try {
        const response = await fetch(`${API_BASE}/Auth/update-password`, {
          method: 'PUT',
          headers: getAuthHeaders(),
          body: JSON.stringify({ oldPassword, newPassword })
        });

        const data = await response.json();
        if (response.ok) {
          showAlert('‚úÖ Password updated successfully!', 'success');
          e.target.reset();
        } else {
          showAlert(data.message || 'Failed to update password');
        }
      } catch (error) {
        showAlert('Network error. Please try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Update Password';
      }
    }

    // Logout
    async function logout() {
      try {
        const accessToken = localStorage.getItem("accessToken");
        await fetch(`${API_BASE}/Auth/logout`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${accessToken}`
          }
        });
      } catch (err) {
        console.error("Logout error:", err);
      } finally {
        localStorage.clear();
        window.location.href = "signin.html";
      }
    }

    // Event listeners
    document.getElementById("refreshTokenBtn").addEventListener("click", refreshTokens);
    document.getElementById("showTokensBtn").addEventListener("click", displayCurrentTokens);
    document.getElementById("navLogoutBtn").addEventListener("click", logout);

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      if (checkAuth()) {
        await loadUserProfile();
        displayCurrentTokens();
      }
    });
  </script>
</body>
</html>