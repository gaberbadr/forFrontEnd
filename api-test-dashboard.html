<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PetMat API Testing Dashboard</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        /* (styles same as before) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .config-section { background: #f8f9fa; padding: 25px; border-bottom: 3px solid #667eea; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap: 15px; margin-bottom: 15px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-weight: 600; margin-bottom: 5px; color: #333; font-size: 0.9em; }
        .input-group input { padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; transition: all .3s; }
        .input-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,.1); }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #ddd; overflow-x: auto; }
        .tab { padding: 15px 25px; cursor: pointer; background: transparent; border: none; font-size: 1em; font-weight: 600; color: #666; transition: all .3s; white-space: nowrap; }
        .tab:hover { background: rgba(102,126,234,.1); }
        .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .endpoint-section { margin-bottom: 30px; border: 2px solid #e0e0e0; border-radius: 12px; overflow: hidden; }
        .endpoint-header { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color: white; padding: 15px 20px; font-weight: 600; display:flex; justify-content:space-between; align-items:center; }
        .method-badge { padding:5px 12px; border-radius:20px; font-size:.85em; font-weight:700; }
        .method-get { background: #28a745; } .method-post { background: #007bff; } .method-put { background: #ffc107; color:#333 } .method-delete { background: #dc3545; }
        .endpoint-body { padding: 20px; background: #fafafa; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display:block; margin-bottom:5px; font-weight:600; color:#333; }
        .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px; border:2px solid #ddd; border-radius:6px; font-size:.95em; }
        .form-group textarea { min-height:100px; font-family:monospace; }
        .btn { padding: 12px 30px; border:none; border-radius:8px; font-size:1em; font-weight:600; cursor:pointer; transition:all .3s; margin-right:10px; }
        .btn-primary { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; } .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,.4); }
        .btn-secondary { background:#6c757d; color:white; }
        .response-box { margin-top:15px; padding:15px; background:#1e1e1e; color:#d4d4d4; border-radius:8px; font-family:'Courier New', monospace; font-size:.9em; max-height:400px; overflow:auto; white-space:pre-wrap; word-wrap:break-word; }
        .status-indicator { display:inline-block; padding:5px 15px; border-radius:20px; font-weight:600; font-size:.9em; margin-left:10px; }
        .status-success { background:#d4edda; color:#155724; } .status-error { background:#f8d7da; color:#721c24; }
        .info-box { background:#e7f3ff; border-left:4px solid #2196F3; padding:15px; margin-bottom:20px; border-radius:4px; }
        .warning-box { background:#fff3cd; border-left:4px solid #ffc107; padding:15px; margin-bottom:20px; border-radius:4px; }
        .success-box { background:#d4edda; border-left:4px solid #28a745; padding:15px; margin-bottom:20px; border-radius:4px; }
        .card-element-container { border:2px solid #ddd; padding:15px; border-radius:8px; background:white; margin-bottom:15px; }
        .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:15px; } @media (max-width:768px) { .grid-2 { grid-template-columns:1fr; } }
        .workflow-steps { background:#f8f9fa; padding:20px; border-radius:8px; margin-bottom:20px; }
        .workflow-steps h3 { margin-bottom:15px; color:#667eea; } .workflow-steps ol { margin-left:20px; } .workflow-steps li { margin-bottom:10px; line-height:1.6; }
        .loading { display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:white; animation:spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêæ PetMat API Testing Dashboard</h1>
            <p>Complete API Testing Interface ‚Äî Updated for new payment/order flow</p>
        </div>

        <div class="config-section">
            <h2 style="margin-bottom:20px;color:#333;">‚öôÔ∏è Configuration</h2>
            <div class="config-grid">
                <div class="input-group">
                    <label>API Base URL</label>
                    <input type="text" id="baseUrl" value="https://localhost:7289" placeholder="https://localhost:7289" />
                </div>
                <div class="input-group">
                    <label>Access Token (Bearer)</label>
                    <input type="text" id="accessToken" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6..." />
                </div>
                <div class="input-group">
                    <label>Stripe Publishable Key</label>
                    <input type="text" id="stripeKey" placeholder="pk_test_..." />
                </div>
            </div>
            <div style="font-size:.9em;color:#555;">
                Notes: For online orders the server now creates the PaymentIntent during order creation and returns the client_secret inside the Order response. The frontend should read that client_secret from the Create Order response and use it to confirm payment.
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="openTab('workflow')">üîÑ Workflow Guide</button>
            <button class="tab" onclick="openTab('auth')">üîê Auth</button>
            <button class="tab" onclick="openTab('products')">üõçÔ∏è Products</button>
            <button class="tab" onclick="openTab('cart')">üõí Cart</button>
            <button class="tab" onclick="openTab('payment')">üí≥ Payment</button>
            <button class="tab" onclick="openTab('orders')">üì¶ Orders</button>
            <button class="tab" onclick="openTab('animals')">ü¶Å Animals</button>
            <button class="tab" onclick="openTab('admin')">üë®‚Äçüíº Admin</button>
        </div>

        <!-- WORKFLOW -->
        <div id="workflow" class="tab-content active">
            <h2>üîÑ Complete Workflow Guide</h2>
            <div class="success-box"><strong>‚úÖ NEW WORKFLOW:</strong> Order is created BEFORE payment completion for online payments.</div>
            <div class="workflow-steps">
                <h3>üí≥ Online Payment Workflow (Stripe)</h3>
                <ol>
                    <li>Login / Get token</li>
                    <li>Add products to cart</li>
                    <li>Optionally apply coupon</li>
                    <li><strong>Create Order</strong> (POST /api/order) with PaymentMethod = Online ‚Äî server will create a PaymentIntent for this order and return client_secret in the response.</li>
                    <li>Use the returned client_secret to confirm payment in the Payment tab using Stripe.js</li>
                    <li>Stripe webhook updates order status: success ‚Üí <code>Processing</code>, failure ‚Üí <code>Cancelled</code>.</li>
                </ol>
            </div>
            <div class="info-box">
                <strong>‚ÑπÔ∏è Key Notes:</strong><br>
                ‚Ä¢ PaymentIntent is created during order creation on the server; frontend no longer calls a dedicated payment-intent endpoint.<br>
                ‚Ä¢ Cart is cleared after order creation; server returns client_secret so frontend can proceed to collect payment.<br>
                ‚Ä¢ Stock is deducted at order creation; failed payment ‚Üí webhook cancels and restores stock.
            </div>
        </div>

        <!-- AUTH (unchanged - keep minimal) -->
        <div id="auth" class="tab-content">
            <h2>üîê Authentication</h2>
            <div class="endpoint-section">
                <div class="endpoint-header"><span>Login</span><span class="method-badge method-post">POST</span></div>
                <div class="endpoint-body">
                    <div class="form-group"><label>Email</label><input type="email" id="loginEmail" value="test@example.com" /></div>
                    <div class="form-group"><label>Password</label><input type="password" id="loginPassword" value="Password123" /></div>
                    <button class="btn btn-primary" onclick="login()">Login</button>
                    <button class="btn btn-secondary" onclick="copyTokenToConfig()">Copy Token to Config</button>
                    <div id="loginResponse" class="response-box" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- PRODUCTS TAB -->
        <div id="products" class="tab-content">
            <h2>üõçÔ∏è Products</h2>

            <div class="endpoint-section">
                <div class="endpoint-header"><span>Get All Products</span><span class="method-badge method-get">GET</span></div>
                <div class="endpoint-body">
                    <div class="form-group"><label>Page</label><input type="number" id="productsPageIndex" value="1" /></div>
                    <button class="btn btn-primary" onclick="getAllProducts()">Get Products</button>
                    <div id="productsResponse" class="response-box" style="display:none;"></div>
                </div>
            </div>

            <!-- Quick Add to Cart UI -->
            <div class="endpoint-section">
                <div class="endpoint-header"><span>Add Product to Cart</span><span class="method-badge method-post">POST</span></div>
                <div class="endpoint-body">
                    <div class="grid-2">
                        <div class="form-group"><label>Product ID</label><input type="number" id="cartProductId" value="1" /></div>
                        <div class="form-group"><label>Quantity</label><input type="number" id="cartQuantity" value="1" /></div>
                    </div>
                    <button class="btn btn-primary" onclick="addToCart()">Add to Cart</button>
                    <div id="addToCartResponse" class="response-box" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- CART TAB -->
        <div id="cart" class="tab-content">
            <h2>üõí Shopping Cart</h2>

            <div class="endpoint-section">
                <div class="endpoint-header"><span>Get My Cart</span><span class="method-badge method-get">GET</span></div>
                <div class="endpoint-body">
                    <button class="btn btn-primary" onclick="getCart()">Get Cart</button>
                    <div id="cartResponse" class="response-box" style="display:none;"></div>
                </div>
            </div>

            <div class="endpoint-section">
                <div class="endpoint-header"><span>Apply Coupon</span><span class="method-badge method-post">POST</span></div>
                <div class="endpoint-body">
                    <div class="form-group"><label>Coupon Code</label><input type="text" id="couponCode" value="SAVE10" /></div>
                    <button class="btn btn-primary" onclick="applyCoupon()">Apply Coupon</button>
                    <button class="btn btn-secondary" onclick="removeCoupon()">Remove Coupon</button>
                    <div id="couponResponse" class="response-box" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- PAYMENT TAB -->
        <div id="payment" class="tab-content">
            <h2>üí≥ Payment (Online orders)</h2>

            <div class="endpoint-section">
                <div class="endpoint-header"><span>Complete Payment with Stripe</span><span class="method-badge method-post">POST</span></div>
                <div class="endpoint-body">
                    <div class="info-box">
                        ‚ÑπÔ∏è Create the order first (Orders tab). If the order is Online, the server returns a client_secret inside the order response. Paste that client_secret below (or create order here and the UI will populate it).
                    </div>

                    <div class="form-group">
                        <label>Client Secret (from order response)</label>
                        <input type="text" id="clientSecret" placeholder="pi_xxx_secret_yyy" />
                    </div>

                    <div class="form-group">
                        <label>Card Details</label>
                        <div id="card-element" class="card-element-container"></div>
                    </div>

                    <button class="btn btn-primary" onclick="completePayment()">Complete Payment</button>
                    <div id="paymentResponse" class="response-box" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- ORDERS TAB -->
        <div id="orders" class="tab-content">
            <h2>üì¶ Orders</h2>

            <div class="endpoint-section">
                <div class="endpoint-header"><span>Create Order</span><span class="method-badge method-post">POST</span></div>
                <div class="endpoint-body">
                    <div class="form-group"><label>Payment Method</label>
                        <select id="paymentMethod"><option value="1">1 - Online</option><option value="2">2 - Cash on Delivery</option></select>
                    </div>

                    <div class="form-group"><label>Delivery Method ID</label><input type="number" id="orderDeliveryMethodId" value="1" /></div>

                    <div class="grid-2">
                        <div class="form-group"><label>First Name</label><input type="text" id="orderFName" value="John" /></div>
                        <div class="form-group"><label>Last Name</label><input type="text" id="orderLName" value="Doe" /></div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group"><label>City</label><input type="text" id="orderCity" value="Cairo" /></div>
                        <div class="form-group"><label>Country</label><input type="text" id="orderCountry" value="Egypt" /></div>
                    </div>
                    <div class="form-group"><label>Street Address</label><input type="text" id="orderStreet" value="123 Main Street" /></div>

                    <button class="btn btn-primary" onclick="createOrder()">Create Order</button>
                    <div id="createOrderResponse" class="response-box" style="display:none;"></div>
                </div>
            </div>

            <div class="endpoint-section">
                <div class="endpoint-header"><span>Get My Orders</span><span class="method-badge method-get">GET</span></div>
                <div class="endpoint-body">
                    <button class="btn btn-primary" onclick="getMyOrders()">Get My Orders</button>
                    <div id="myOrdersResponse" class="response-box" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- ADMIN TAB -->
        <div id="admin" class="tab-content">
            <h2>üë®‚Äçüíº Admin</h2>

            <div class="endpoint-section">
                <div class="endpoint-header"><span>Add Product (Admin)</span><span class="method-badge method-post">POST</span></div>
                <div class="endpoint-body">
                    <div class="form-group"><label>Product Name</label><input type="text" id="adminProductName" value="New Food" /></div>
                    <div class="form-group"><label>Description</label><textarea id="adminProductDescription">Tasty pet food</textarea></div>
                    <div class="grid-2">
                        <div class="form-group"><label>Price</label><input type="number" id="adminProductPrice" value="9.99" step="0.01" /></div>
                        <div class="form-group"><label>Stock</label><input type="number" id="adminProductStock" value="100" /></div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group"><label>Brand ID</label><input type="number" id="adminProductBrandId" value="1" /></div>
                        <div class="form-group"><label>Type ID</label><input type="number" id="adminProductTypeId" value="1" /></div>
                    </div>
                    <div class="form-group"><label>Species ID (optional)</label><input type="number" id="adminProductSpeciesId" /></div>
                    <div class="form-group"><label>Picture</label><input type="file" id="adminProductPicture" accept="image/*" /></div>
                    <div class="form-group"><label>Expiry Date</label><input type="date" id="adminProductExpiry" /></div>
                    <button class="btn btn-primary" onclick="createProduct()">Add Product</button>
                    <div id="createProductResponse" class="response-box" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- animals omitted for brevity -->
    </div>

    <script>
        let stripe = null;
        let cardElement = null;
        let lastLoginResponse = null;

        function initializeStripe() {
            const stripeKey = document.getElementById('stripeKey').value.trim();
            if (!stripeKey) return;
            if (!stripe || stripe._key !== stripeKey) {
                stripe = Stripe(stripeKey);
                stripe._key = stripeKey;
                const elements = stripe.elements();
                if (cardElement) { cardElement.unmount(); cardElement = null; }
                cardElement = elements.create('card');
                cardElement.mount('#card-element');
            }
        }

        function openTab(tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) tabContents[i].classList.remove('active');
            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
            document.getElementById(tabName).classList.add('active');
            // Activate corresponding tab button if possible
            for (let i = 0; i < tabs.length; i++) {
                if (tabs[i].textContent.trim().toLowerCase().startsWith(tabName.toLowerCase().slice(0,1)) === false) {
                    // noop - keep previous behavior minimal
                }
            }
            // Initialize stripe when opening payment tab
            if (tabName === 'payment') initializeStripe();
        }

        function getHeaders(includeAuth = true) {
            const headers = {};
            if (includeAuth) {
                const token = document.getElementById('accessToken').value.trim();
                if (token) headers['Authorization'] = `Bearer ${token}`;
            }
            return headers;
        }

        function getBaseUrl() { return document.getElementById('baseUrl').value; }

        function displayResponse(elementId, response, status) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = JSON.stringify(response, null, 2);
            if (status !== undefined && status !== null) {
                const statusClass = status >= 200 && status < 300 ? 'status-success' : 'status-error';
                element.innerHTML = `<span class="status-indicator ${statusClass}">Status: ${status}</span>\n\n` + element.textContent;
            }
        }

        // AUTH helpers (simple)
        async function login() {
            const data = { email: document.getElementById('loginEmail').value, password: document.getElementById('loginPassword').value };
            try {
                const r = await fetch(`${getBaseUrl()}/api/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const json = await r.json();
                lastLoginResponse = json;
                displayResponse('loginResponse', json, r.status);
                if (json.token) alert('‚úÖ Login successful. Click copy token to config.');
            } catch (e) { displayResponse('loginResponse', { error: e.message }, 0); }
        }
        function copyTokenToConfig() { if (lastLoginResponse && lastLoginResponse.token) { document.getElementById('accessToken').value = lastLoginResponse.token; alert('Token copied'); } else alert('Login first'); }

        // PRODUCTS & CART functions

        async function getAllProducts() {
            try {
                const response = await fetch(`${getBaseUrl()}/api/product?pageIndex=${document.getElementById('productsPageIndex').value || 1}&pageSize=20`, { method: 'GET' });
                const result = await response.json();
                displayResponse('productsResponse', result, response.status);
            } catch (err) { displayResponse('productsResponse', { error: err.message }, 0); }
        }

        // Add to cart
        async function addToCart() {
            const productId = parseInt(document.getElementById('cartProductId').value);
            const quantity = parseInt(document.getElementById('cartQuantity').value) || 1;
            const data = { productId: productId, quantity: quantity };

            try {
                const response = await fetch(`${getBaseUrl()}/api/cart/add`, {
                    method: 'POST',
                    headers: Object.assign({ 'Content-Type': 'application/json' }, getHeaders(true)),
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                displayResponse('addToCartResponse', result, response.status);
                if (response.ok) alert('‚úÖ Added to cart');
            } catch (err) { displayResponse('addToCartResponse', { error: err.message }, 0); }
        }

        async function getCart() {
            try {
                const response = await fetch(`${getBaseUrl()}/api/cart`, { method: 'GET', headers: getHeaders(true) });
                const result = await response.json();
                displayResponse('cartResponse', result, response.status);
            } catch (err) { displayResponse('cartResponse', { error: err.message }, 0); }
        }

        // Apply coupon
        async function applyCoupon() {
            const code = document.getElementById('couponCode').value.trim();
            if (!code) { alert('Enter coupon code'); return; }
            const data = { couponCode: code };

            try {
                const response = await fetch(`${getBaseUrl()}/api/cart/coupon`, {
                    method: 'POST',
                    headers: Object.assign({ 'Content-Type': 'application/json' }, getHeaders(true)),
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                displayResponse('couponResponse', result, response.status);
                if (response.ok) alert('‚úÖ Coupon applied');
            } catch (err) { displayResponse('couponResponse', { error: err.message }, 0); }
        }

        async function removeCoupon() {
            try {
                const response = await fetch(`${getBaseUrl()}/api/cart/coupon`, { method: 'DELETE', headers: getHeaders(true) });
                const result = await response.json();
                displayResponse('couponResponse', result, response.status);
                if (response.ok) alert('‚úÖ Coupon removed');
            } catch (err) { displayResponse('couponResponse', { error: err.message }, 0); }
        }

        // PAYMENT functions (complete payment)
        async function completePayment() {
            const clientSecret = document.getElementById('clientSecret').value.trim();
            if (!clientSecret) { alert('Provide client secret (returned in Create Order response)'); return; }
            if (!stripe || !cardElement) { alert('Initialize Stripe key first (open Payment tab and set publishable key)'); return; }

            try {
                // Optional: validate order exists ‚Äî server will still accept payment if order attached to intent
                const paymentIntentId = clientSecret.split('_secret_')[0];
                const validate = await fetch(`${getBaseUrl()}/api/order/validate-payment/${paymentIntentId}`, { method: 'GET', headers: getHeaders(true) });
                if (!validate.ok) {
                    const err = await validate.json();
                    displayResponse('paymentResponse', { error: 'No order for this payment intent', details: err }, validate.status);
                    alert('No order found for this payment intent ‚Äî create order first.');
                    return;
                }

                displayResponse('paymentResponse', { status: 'Processing payment...' }, null);

                const result = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: { card: cardElement }
                });

                if (result.error) {
                    displayResponse('paymentResponse', { error: result.error.message, detail: result.error }, 400);
                    alert('Payment failed. Webhook will update order status.');
                } else {
                    // paymentIntent available in result.paymentIntent
                    displayResponse('paymentResponse', { success: true, paymentIntent: { id: result.paymentIntent.id, status: result.paymentIntent.status, amount: result.paymentIntent.amount/100 } }, 200);
                    alert('Payment succeeded. Webhook will update order status to Processing.');
                }
            } catch (err) { displayResponse('paymentResponse', { error: err.message }, 0); }
        }

        // ORDERS functions (create order - server creates PaymentIntent for online)
        async function createOrder() {
            const paymentMethod = parseInt(document.getElementById('paymentMethod').value);
            const data = {
                deliveryMethodId: parseInt(document.getElementById('orderDeliveryMethodId').value),
                paymentMethod: paymentMethod,
                shippingAddress: {
                    fName: document.getElementById('orderFName').value,
                    lName: document.getElementById('orderLName').value,
                    city: document.getElementById('orderCity').value,
                    street: document.getElementById('orderStreet').value,
                    country: document.getElementById('orderCountry').value
                }
            };

            try {
                const response = await fetch(`${getBaseUrl()}/api/order`, {
                    method: 'POST',
                    headers: Object.assign({ 'Content-Type': 'application/json' }, getHeaders(true)),
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                displayResponse('createOrderResponse', result, response.status);

                if (!response.ok) {
                    return;
                }

                // If server returned clientSecret (online payment) set it into payment tab
                if (result && result.clientSecret) {
                    document.getElementById('clientSecret').value = result.clientSecret;
                    // help user proceed to payment tab
                    alert('‚úÖ Order created with PendingPayment. Client secret was returned and populated in the Payment tab. Open Payment tab to complete payment.');
                } else {
                    alert('‚úÖ Order created successfully.');
                }
            } catch (err) { displayResponse('createOrderResponse', { error: err.message }, 0); }
        }

        async function getMyOrders() {
            try {
                const response = await fetch(`${getBaseUrl()}/api/order/my-orders`, { method: 'GET', headers: getHeaders(true) });
                const result = await response.json();
                displayResponse('myOrdersResponse', result, response.status);
            } catch (err) { displayResponse('myOrdersResponse', { error: err.message }, 0); }
        }

        async function getOrderById() {
            const id = document.getElementById('orderId') ? document.getElementById('orderId').value : 0;
            try {
                const response = await fetch(`${getBaseUrl()}/api/order/${id}`, { method: 'GET', headers: getHeaders(true) });
                const result = await response.json();
                displayResponse('orderByIdResponse', result, response.status);
            } catch (err) { displayResponse('orderByIdResponse', { error: err.message }, 0); }
        }

        // ADMIN: create product (form-data)
        async function createProduct() {
            const name = document.getElementById('adminProductName').value.trim();
            const description = document.getElementById('adminProductDescription').value.trim();
            const price = document.getElementById('adminProductPrice').value;
            const stock = document.getElementById('adminProductStock').value;
            const brandId = document.getElementById('adminProductBrandId').value;
            const typeId = document.getElementById('adminProductTypeId').value;
            const speciesId = document.getElementById('adminProductSpeciesId').value;
            const pictureInput = document.getElementById('adminProductPicture');
            const expiry = document.getElementById('adminProductExpiry').value;

            if (!name || !price || !stock || !brandId || !typeId) { alert('Fill required fields'); return; }
            const fd = new FormData();
            fd.append('Name', name);
            fd.append('Description', description);
            if (pictureInput.files && pictureInput.files[0]) fd.append('PictureFile', pictureInput.files[0]);
            fd.append('Price', price);
            fd.append('Stock', stock);
            fd.append('BrandId', brandId);
            fd.append('TypeId', typeId);
            if (speciesId) fd.append('SpeciesId', speciesId);
            if (expiry) fd.append('ExpiryDate', expiry);

            try {
                const headers = getHeaders(true); // include auth
                const response = await fetch(`${getBaseUrl()}/api/adminproduct/product`, {
                    method: 'POST',
                    headers: headers, // DO NOT set Content-Type; browser will set boundary
                    body: fd
                });
                const result = await response.json();
                displayResponse('createProductResponse', result, response.status);
                if (response.ok) alert('‚úÖ Product created');
            } catch (err) { displayResponse('createProductResponse', { error: err.message }, 0); }
        }

        // Re-initialize Stripe when key changes
        document.getElementById('stripeKey').addEventListener('change', initializeStripe);
    </script>
</body>
</html>